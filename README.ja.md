[English](./README.md) | [한국어](./README.ko.md) | [中文](./README.zh.md)

# Summary Bot

> Telegram ボットに URL またはテキストを送信すると、LLM が自動で要約し、GitHub リポジトリにマークダウンファイルとして保存する NestJS アプリケーション

## 主な機能

- **URL コンテンツ抽出**: Web ページの URL を送信すると、本文を自動抽出して要約
- **X(Twitter) ツイート対応**: ツイート内の共有リンクを自動検出し、該当する原文を抽出して要約
- **テキスト要約**: URL 以外の一般テキストも要約可能
- **デュアル LLM プロバイダー**: Claude と Gemini をサポートし、Primary 失敗時に自動 Fallback
- **GitHub 自動保存**: 要約結果をマークダウンファイルとして GitHub リポジトリに自動コミット
- **知識グラフ構造**: 要約時に上位/下位/関連概念を分類し、ナレッジマップの構築を支援

## アーキテクチャ

```
Telegram → TelegramUpdate (Handler)
               ↓
         SummaryService (Orchestrator)
          ↓         ↓          ↓
  ExtractorService  LlmService  GithubService
                    ↓      ↓
            ClaudeProvider  GeminiProvider
```

### モジュール構成

| モジュール | 役割 |
|------|------|
| `TelegramModule` | Telegram Webhook の受信およびユーザーインタラクション処理 |
| `SummaryModule` | 要約パイプラインのオーケストレーションおよびキャッシュ管理 |
| `ExtractorModule` | URL からコンテンツを抽出 (article-extractor, raw fetch, oEmbed) |
| `LlmModule` | LLM プロバイダー管理および Fallback ロジック |
| `GithubModule` | マークダウン生成および GitHub API によるファイル保存 |
| `HealthModule` | ヘルスチェックエンドポイント (`GET /health`) |

## 処理フロー

1. ユーザーが Telegram で URL またはテキストを送信
2. `ExtractorService` が入力を解析:
   - **URL の場合**: Web ページの本文を抽出 (article-extractor → raw fetch → oEmbed の順に試行)
   - **X/Twitter URL の場合**: fxtwitter API でツイート内のリンクを解決した後、該当 URL の本文を抽出
   - **テキストの場合**: 原文をそのまま使用
3. `LlmService` が抽出されたコンテンツを LLM で要約:
   - 韓国語タイトル、英語 slug、カテゴリ、タグ、キーワード、概念分類、インサイト、マークダウン要約を生成
4. `GithubService` が要約結果をマークダウンファイルに変換し GitHub に自動コミット
5. Telegram に要約プレビューと GitHub リンクを送信
6. ユーザーは `削除` ボタンでキャッシュを削除したり、エラー時に `リトライ` ボタンで再要約が可能

## 要約結果の構造

LLM が生成する要約結果には以下のフィールドが含まれます:

| フィールド | 説明 |
|------|------|
| `title` | 韓国語タイトル (15文字以内) |
| `description` | 英語 kebab-case slug (ファイル名用) |
| `category` | `Tech` / `AI` / `Business` / `Design` / `Productivity` / `Life` のいずれか |
| `tags` | 英語タグ 3~5個 |
| `keywords` | 韓国語キーワード 3~7個 |
| `concepts.upper` | 上位概念 1~3個 |
| `concepts.lower` | 下位/詳細概念 2~5個 |
| `concepts.related` | 関連概念 2~5個 |
| `insights` | 核心インサイト 3~5個 (宣言的な文) |
| `summary` | マークダウン形式の詳細要約 |

## GitHub 保存形式

保存パス: `{SUMMARY_DIR}/YYYY-MM-DD-{slug}.md`

```markdown
---
title: "리액트 서버 컴포넌트의 이해"
date: 2025-02-10
category: Tech
tags: [react, server-components, nextjs]
keywords: [서버 컴포넌트, 클라이언트 컴포넌트, 번들 사이즈]
source: "https://example.com/article"
---

> 원문: https://example.com/article

## 요약 본문 ...

## 핵심 인사이트

- 인사이트 1
- 인사이트 2

## 키워드

`서버 컴포넌트` `클라이언트 컴포넌트` `번들 사이즈`

## 관련 개념

- **상위**: 웹 프레임워크, React 아키텍처
- **하위**: use client 지시어, 서버 전용 코드
- **연관**: 하이드레이션, Islands Architecture

> Auto-generated by Summary Bot on 2025-02-10
```

## 技術スタック

- **ランタイム**: Node.js 20
- **フレームワーク**: NestJS 11
- **言語**: TypeScript 5.7
- **Telegram**: Telegraf + nestjs-telegraf (Webhook モード)
- **LLM**: Anthropic Claude (`claude-sonnet-4-20250514`) / Google Gemini (`gemini-2.5-pro`)
- **GitHub**: Octokit REST API
- **コンテンツ抽出**: @extractus/article-extractor
- **パッケージマネージャー**: pnpm 9.15
- **デプロイ**: Docker (Multi-stage build)

## はじめに

### 前提条件

- Node.js 20+
- pnpm 9.15+
- Telegram Bot Token ([BotFather](https://t.me/BotFather) で作成)
- LLM API キー (Anthropic または Google AI のいずれか1つ以上)
- GitHub Personal Access Token (repo 権限)

### インストール

```bash
# リポジトリをクローン
git clone <repository-url>
cd summary-bot

# 依存関係をインストール
pnpm install
```

### 環境変数の設定

`.env.example` を `.env` にコピーし、値を入力します:

```bash
cp .env.example .env
```

| 環境変数 | 必須 | 説明 | デフォルト値 |
|---------|------|------|--------|
| `TELEGRAM_BOT_TOKEN` | O | Telegram Bot API トークン | - |
| `TELEGRAM_WEBHOOK_DOMAIN` | O | Webhook を受信するドメイン (例: `https://example.com`) | - |
| `ANTHROPIC_API_KEY` | △ | Anthropic API キー (Claude 使用時に必須) | - |
| `GEMINI_API_KEY` | △ | Google AI API キー (Gemini 使用時に必須) | - |
| `GITHUB_TOKEN` | O | GitHub Personal Access Token | - |
| `GITHUB_REPO` | O | 要約を保存する GitHub リポジトリ (例: `owner/repo`) | - |
| `SUMMARY_DIR` | X | リポジトリ内の要約ファイルディレクトリ | `98-summaries` |
| `LLM_PROVIDER` | X | Primary LLM プロバイダー (`claude` または `gemini`) | `gemini` |
| `PORT` | X | サーバーポート | `3000` |

> LLM API キーは選択した Primary プロバイダーのキーが必須であり、Fallback のために両方を設定することを推奨します。

### 開発モードの実行

```bash
# 開発サーバー (ファイル変更時に自動再起動)
pnpm start:dev

# デバッグモード
pnpm start:debug
```

### プロダクションビルドと実行

```bash
# ビルド
pnpm build

# プロダクション実行
pnpm start:prod
```

### Docker での実行

```bash
# イメージをビルド
docker build -t summary-bot .

# コンテナを実行
docker run -d \
  --name summary-bot \
  -p 3000:3000 \
  --env-file .env \
  summary-bot
```

### Webhook の設定

ボットが起動したら、Telegram に Webhook URL を登録する必要があります:

```
https://{TELEGRAM_WEBHOOK_DOMAIN}/api/telegram-webhook
```

`nestjs-telegraf` がアプリ起動時に自動で Webhook を設定します。`TELEGRAM_WEBHOOK_DOMAIN` 環境変数に外部からアクセス可能なドメインを指定してください。

ローカル開発時には [ngrok](https://ngrok.com/) などのトンネリングツールを使用できます:

```bash
ngrok http 3000
# 出力された HTTPS URL を TELEGRAM_WEBHOOK_DOMAIN に設定
```

## 使い方

1. Telegram でボットに DM で URL またはテキストを送信します。
2. ボットが「要約中...」ステータスを表示し、コンテンツを処理します。
3. 要約が完了すると、以下の情報を含むプレビューメッセージが送信されます:
   - タイトルおよびカテゴリ/タグ
   - 要約プレビュー (300文字)
   - 核心インサイト
   - キーワード
   - GitHub リンク
4. `削除` ボタンを押してキャッシュから削除し、メッセージを削除できます。
5. エラー発生時は `リトライ` ボタンで再要約を試行できます。

## スクリプト

| コマンド | 説明 |
|--------|------|
| `pnpm start:dev` | 開発サーバーの実行 (watch モード) |
| `pnpm start:debug` | デバッグモードの実行 |
| `pnpm build` | プロダクションビルド |
| `pnpm start:prod` | プロダクション実行 |
| `pnpm lint` | ESLint の実行 |
| `pnpm format` | Prettier フォーマット |

## プロジェクト構造

```
src/
├── main.ts                      # NestJS ブートストラップおよび Webhook 設定
├── app.module.ts                # ルートモジュール
├── config/
│   └── configuration.ts         # 環境変数設定
├── telegram/
│   ├── telegram.module.ts       # Telegram モジュール (Webhook 設定)
│   └── telegram.update.ts       # メッセージハンドラーおよびインラインボタン処理
├── summary/
│   ├── summary.module.ts        # Summary モジュール
│   └── summary.service.ts       # 要約パイプラインのオーケストレーション
├── extractor/
│   ├── extractor.module.ts      # Extractor モジュール
│   └── extractor.service.ts     # URL/テキストコンテンツの抽出
├── llm/
│   ├── llm.module.ts            # LLM モジュール
│   ├── llm.service.ts           # LLM サービス (Fallback ロジック)
│   ├── llm.interface.ts         # SummaryResult インターフェース
│   ├── prompts.ts               # LLM システム/ユーザープロンプト
│   └── providers/
│       ├── claude.provider.ts   # Anthropic Claude プロバイダー
│       └── gemini.provider.ts   # Google Gemini プロバイダー
├── github/
│   ├── github.module.ts         # GitHub モジュール
│   └── github.service.ts        # GitHub マークダウン保存
└── health/
    ├── health.module.ts         # Health モジュール
    └── health.controller.ts     # GET /health エンドポイント
```

## ライセンス

MIT
