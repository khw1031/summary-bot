[English](./README.md) | [日本語](./README.ja.md) | [中文](./README.zh.md)

# Summary Bot

> Telegram 봇으로 URL 또는 텍스트를 보내면 LLM이 자동으로 요약하고, GitHub 저장소에 마크다운 파일로 저장하는 NestJS 애플리케이션

## 주요 기능

- **URL 콘텐츠 추출**: 웹 페이지 URL을 보내면 본문을 자동 추출하여 요약
- **X(Twitter) 트윗 지원**: 트윗 내 공유된 링크를 자동으로 감지하고, 해당 원문을 추출하여 요약
- **텍스트 요약**: URL이 아닌 일반 텍스트도 요약 가능
- **듀얼 LLM 프로바이더**: Claude와 Gemini를 지원하며, Primary 실패 시 자동 Fallback
- **GitHub 자동 저장**: 요약 결과를 마크다운 파일로 GitHub 저장소에 자동 커밋
- **지식 그래프 구조**: 요약 시 상위/하위/연관 개념을 함께 분류하여 지식 맵 구축 지원

## 아키텍처

```
Telegram → TelegramUpdate (Handler)
               ↓
         SummaryService (Orchestrator)
          ↓         ↓          ↓
  ExtractorService  LlmService  GithubService
                    ↓      ↓
            ClaudeProvider  GeminiProvider
```

### 모듈 구성

| 모듈 | 역할 |
|------|------|
| `TelegramModule` | Telegram Webhook 수신 및 사용자 인터랙션 처리 |
| `SummaryModule` | 요약 파이프라인 오케스트레이션 및 캐시 관리 |
| `ExtractorModule` | URL에서 콘텐츠 추출 (article-extractor, raw fetch, oEmbed) |
| `LlmModule` | LLM 프로바이더 관리 및 Fallback 로직 |
| `GithubModule` | 마크다운 생성 및 GitHub API를 통한 파일 저장 |
| `HealthModule` | 헬스 체크 엔드포인트 (`GET /health`) |

## 처리 흐름

1. 사용자가 Telegram으로 URL 또는 텍스트를 전송
2. `ExtractorService`가 입력을 분석:
   - **URL인 경우**: 웹 페이지 본문을 추출 (article-extractor → raw fetch → oEmbed 순으로 시도)
   - **X/Twitter URL인 경우**: fxtwitter API로 트윗 내 링크를 해석한 뒤 해당 URL의 본문을 추출
   - **텍스트인 경우**: 원문 그대로 사용
3. `LlmService`가 추출된 콘텐츠를 LLM으로 요약:
   - 한글 제목, 영문 slug, 카테고리, 태그, 키워드, 개념 분류, 인사이트, 마크다운 요약 생성
4. `GithubService`가 요약 결과를 마크다운 파일로 변환하여 GitHub에 자동 커밋
5. Telegram으로 요약 미리보기와 GitHub 링크를 전송
6. 사용자는 `삭제` 버튼으로 캐시를 제거하거나, 오류 시 `재시도` 버튼으로 재요약 가능

## 요약 결과 구조

LLM이 생성하는 요약 결과는 다음 필드를 포함합니다:

| 필드 | 설명 |
|------|------|
| `title` | 한글 제목 (15자 이내) |
| `description` | 영문 kebab-case slug (파일명용) |
| `category` | `Tech` / `AI` / `Business` / `Design` / `Productivity` / `Life` 중 하나 |
| `tags` | 영문 태그 3~5개 |
| `keywords` | 한글 핵심 키워드 3~7개 |
| `concepts.upper` | 상위 개념 1~3개 |
| `concepts.lower` | 하위/세부 개념 2~5개 |
| `concepts.related` | 연관 개념 2~5개 |
| `insights` | 핵심 인사이트 3~5개 (선언적 문장) |
| `summary` | 마크다운 형식의 상세 요약 |

## GitHub 저장 형식

저장 경로: `{SUMMARY_DIR}/YYYY-MM-DD-{slug}.md`

```markdown
---
title: "리액트 서버 컴포넌트의 이해"
date: 2025-02-10
category: Tech
tags: [react, server-components, nextjs]
keywords: [서버 컴포넌트, 클라이언트 컴포넌트, 번들 사이즈]
source: "https://example.com/article"
---

> 원문: https://example.com/article

## 요약 본문 ...

## 핵심 인사이트

- 인사이트 1
- 인사이트 2

## 키워드

`서버 컴포넌트` `클라이언트 컴포넌트` `번들 사이즈`

## 관련 개념

- **상위**: 웹 프레임워크, React 아키텍처
- **하위**: use client 지시어, 서버 전용 코드
- **연관**: 하이드레이션, Islands Architecture

> Auto-generated by Summary Bot on 2025-02-10
```

## 기술 스택

- **런타임**: Node.js 20
- **프레임워크**: NestJS 11
- **언어**: TypeScript 5.7
- **Telegram**: Telegraf + nestjs-telegraf (Webhook 모드)
- **LLM**: Anthropic Claude (`claude-sonnet-4-20250514`) / Google Gemini (`gemini-2.5-pro`)
- **GitHub**: Octokit REST API
- **콘텐츠 추출**: @extractus/article-extractor
- **패키지 매니저**: pnpm 9.15
- **배포**: Docker (Multi-stage build)

## 시작하기

### 사전 요구사항

- Node.js 20+
- pnpm 9.15+
- Telegram Bot Token ([BotFather](https://t.me/BotFather)에서 생성)
- LLM API 키 (Anthropic 또는 Google AI 중 하나 이상)
- GitHub Personal Access Token (repo 권한)

### 설치

```bash
# 저장소 클론
git clone <repository-url>
cd summary-bot

# 의존성 설치
pnpm install
```

### 환경변수 설정

`.env.example`을 `.env`로 복사한 뒤 값을 채워넣습니다:

```bash
cp .env.example .env
```

| 환경변수 | 필수 | 설명 | 기본값 |
|---------|------|------|--------|
| `TELEGRAM_BOT_TOKEN` | O | Telegram Bot API 토큰 | - |
| `TELEGRAM_WEBHOOK_DOMAIN` | O | Webhook을 수신할 도메인 (예: `https://example.com`) | - |
| `ANTHROPIC_API_KEY` | △ | Anthropic API 키 (Claude 사용 시 필수) | - |
| `GEMINI_API_KEY` | △ | Google AI API 키 (Gemini 사용 시 필수) | - |
| `GITHUB_TOKEN` | O | GitHub Personal Access Token | - |
| `GITHUB_REPO` | O | 요약을 저장할 GitHub 저장소 (예: `owner/repo`) | - |
| `SUMMARY_DIR` | X | 저장소 내 요약 파일 디렉토리 | `98-summaries` |
| `LLM_PROVIDER` | X | Primary LLM 프로바이더 (`claude` 또는 `gemini`) | `gemini` |
| `PORT` | X | 서버 포트 | `3000` |

> LLM API 키는 선택한 Primary 프로바이더의 키가 필수이며, Fallback을 위해 양쪽 모두 설정하는 것을 권장합니다.

### 개발 모드 실행

```bash
# 개발 서버 (파일 변경 시 자동 재시작)
pnpm start:dev

# 디버그 모드
pnpm start:debug
```

### 프로덕션 빌드 및 실행

```bash
# 빌드
pnpm build

# 프로덕션 실행
pnpm start:prod
```

### Docker로 실행

```bash
# 이미지 빌드
docker build -t summary-bot .

# 컨테이너 실행
docker run -d \
  --name summary-bot \
  -p 3000:3000 \
  --env-file .env \
  summary-bot
```

### Webhook 설정

봇이 실행되면 Telegram에 Webhook URL을 등록해야 합니다:

```
https://{TELEGRAM_WEBHOOK_DOMAIN}/api/telegram-webhook
```

`nestjs-telegraf`가 앱 시작 시 자동으로 Webhook을 설정합니다. `TELEGRAM_WEBHOOK_DOMAIN` 환경변수에 외부에서 접근 가능한 도메인을 지정하세요.

로컬 개발 시에는 [ngrok](https://ngrok.com/) 등의 터널링 도구를 사용할 수 있습니다:

```bash
ngrok http 3000
# 출력된 HTTPS URL을 TELEGRAM_WEBHOOK_DOMAIN에 설정
```

## 사용 방법

1. Telegram에서 봇에게 DM으로 URL 또는 텍스트를 전송합니다.
2. 봇이 "요약 중..." 상태를 표시하며 콘텐츠를 처리합니다.
3. 요약이 완료되면 다음 정보가 포함된 미리보기 메시지를 전송합니다:
   - 제목 및 카테고리/태그
   - 요약 미리보기 (300자)
   - 핵심 인사이트
   - 키워드
   - GitHub 링크
4. `삭제` 버튼을 눌러 캐시에서 제거하고 메시지를 삭제할 수 있습니다.
5. 오류 발생 시 `재시도` 버튼으로 재요약을 시도할 수 있습니다.

## 스크립트

| 명령어 | 설명 |
|--------|------|
| `pnpm start:dev` | 개발 서버 실행 (watch 모드) |
| `pnpm start:debug` | 디버그 모드 실행 |
| `pnpm build` | 프로덕션 빌드 |
| `pnpm start:prod` | 프로덕션 실행 |
| `pnpm lint` | ESLint 실행 |
| `pnpm format` | Prettier 포맷팅 |

## 프로젝트 구조

```
src/
├── main.ts                      # NestJS 부트스트랩 및 Webhook 설정
├── app.module.ts                # 루트 모듈
├── config/
│   └── configuration.ts         # 환경변수 설정
├── telegram/
│   ├── telegram.module.ts       # Telegram 모듈 (Webhook 설정)
│   └── telegram.update.ts       # 메시지 핸들러 및 인라인 버튼 처리
├── summary/
│   ├── summary.module.ts        # Summary 모듈
│   └── summary.service.ts       # 요약 파이프라인 오케스트레이션
├── extractor/
│   ├── extractor.module.ts      # Extractor 모듈
│   └── extractor.service.ts     # URL/텍스트 콘텐츠 추출
├── llm/
│   ├── llm.module.ts            # LLM 모듈
│   ├── llm.service.ts           # LLM 서비스 (Fallback 로직)
│   ├── llm.interface.ts         # SummaryResult 인터페이스
│   ├── prompts.ts               # LLM 시스템/유저 프롬프트
│   └── providers/
│       ├── claude.provider.ts   # Anthropic Claude 프로바이더
│       └── gemini.provider.ts   # Google Gemini 프로바이더
├── github/
│   ├── github.module.ts         # GitHub 모듈
│   └── github.service.ts        # GitHub 마크다운 저장
└── health/
    ├── health.module.ts         # Health 모듈
    └── health.controller.ts     # GET /health 엔드포인트
```

## 라이선스

MIT
