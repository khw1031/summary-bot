# Summary Bot - Implementation Roadmap

> Telegram 봇으로 URL/텍스트를 받아 LLM 요약 후 GitHub에 마크다운으로 저장하는 NestJS 앱

---

## Phase 0: 프로젝트 초기화

> 모든 후속 Phase의 기반. project-initializer가 수행 중.

- [ ] **T-01** NestJS 프로젝트 스캐폴딩 및 의존성 설치
  - **파일**: `package.json`, `tsconfig.json`, `tsconfig.build.json`, `nest-cli.json`, `.eslintrc.js`, `.prettierrc`
  - **의존성**: 없음
  - **완료 조건**:
    - pnpm으로 NestJS 프로젝트 생성 완료
    - 핵심 의존성 설치: `telegraf`, `nestjs-telegraf`, `@anthropic-ai/sdk`, `@google/generative-ai`, `@octokit/rest`, `@extractus/article-extractor`
    - `pnpm build` 성공
    - `pnpm start` 시 NestJS 앱 정상 기동

- [ ] **T-02** 기본 프로젝트 구조 생성
  - **파일**: `src/app.module.ts`, `src/main.ts`, 각 모듈 디렉토리 생성
  - **의존성**: T-01
  - **완료 조건**:
    - `src/` 하위에 `telegram/`, `summary/`, `llm/`, `github/`, `extractor/`, `config/` 디렉토리 존재
    - `app.module.ts`에 빈 모듈 import 구조 준비
    - `main.ts`에 NestJS 부트스트랩 코드 작성

---

## Phase 1: 독립 모듈 구현 (병렬 가능)

> config, extractor, llm providers는 서로 의존성 없이 병렬 구현 가능

- [ ] **T-03** Config 모듈 구현
  - **파일**: `src/config/configuration.ts`
  - **의존성**: T-02
  - **완료 조건**:
    - NestJS `ConfigModule`을 사용한 환경변수 로드
    - 필수 환경변수 정의: `TELEGRAM_BOT_TOKEN`, `TELEGRAM_WEBHOOK_DOMAIN`, `ANTHROPIC_API_KEY`, `GEMINI_API_KEY`, `GITHUB_TOKEN`, `GITHUB_REPO`, `LLM_PROVIDER`, `PORT`
    - `app.module.ts`에서 `ConfigModule.forRoot()` 등록
    - 유닛 테스트: 환경변수 정상 로드 확인

- [ ] **T-04** Extractor 모듈 구현
  - **파일**: `src/extractor/extractor.module.ts`, `src/extractor/extractor.service.ts`
  - **의존성**: T-02
  - **완료 조건**:
    - `@extractus/article-extractor`를 사용하여 URL에서 본문 추출
    - `extract(url: string): Promise<{ title: string; content: string; url: string }>` 메서드 구현
    - URL이 아닌 텍스트 입력 시 원본 텍스트 그대로 반환하는 로직
    - 유닛 테스트: URL 추출 성공/실패 케이스, 텍스트 입력 케이스

- [ ] **T-05** Claude Provider 구현
  - **파일**: `src/llm/llm.interface.ts`, `src/llm/prompts.ts`, `src/llm/providers/claude.provider.ts`
  - **의존성**: T-02
  - **완료 조건**:
    - `LlmProvider` 인터페이스 정의 (`summarize(content: string): Promise<SummaryResult>`)
    - `SummaryResult` 인터페이스 정의 (`title`, `description`, `category`, `tags`, `summary`)
    - 요약 프롬프트 정의 (한글 제목, 영문 slug, 카테고리 6종, 태그 3-5개, 마크다운 요약)
    - `@anthropic-ai/sdk` 사용하여 `claude-sonnet-4-20250514` 모델 호출
    - JSON structured output 파싱
    - 유닛 테스트: 프로바이더 호출 및 응답 파싱 검증 (API mock)

- [ ] **T-06** Gemini Provider 구현
  - **파일**: `src/llm/providers/gemini.provider.ts`
  - **의존성**: T-02 (T-05와 병렬 가능, `llm.interface.ts`만 공유)
  - **완료 조건**:
    - `LlmProvider` 인터페이스 구현
    - `@google/generative-ai` 사용하여 `gemini-2.0-flash` 모델 호출
    - T-05와 동일한 프롬프트 사용
    - JSON structured output 파싱
    - 유닛 테스트: 프로바이더 호출 및 응답 파싱 검증 (API mock)

---

## Phase 2: LLM 서비스 통합

> Provider들을 통합하고 fallback 로직을 구현

- [ ] **T-07** LLM 서비스 구현 (fallback 로직)
  - **파일**: `src/llm/llm.module.ts`, `src/llm/llm.service.ts`
  - **의존성**: T-03, T-05, T-06
  - **완료 조건**:
    - `LLM_PROVIDER` 환경변수로 primary 프로바이더 선택 (`claude` | `gemini`)
    - `summarize(content: string): Promise<SummaryResult>` 메서드 구현
    - Primary 프로바이더 실패 시 자동으로 fallback 프로바이더 호출
    - 양쪽 모두 실패 시 명확한 에러 반환
    - `LlmModule`에 providers 등록 및 export
    - 유닛 테스트: primary 성공, primary 실패 -> fallback 성공, 양쪽 실패 케이스

---

## Phase 3: GitHub 서비스 구현

> LLM 서비스와 독립적으로 구현 가능하지만, SummaryResult 인터페이스에 의존

- [ ] **T-08** GitHub 서비스 구현
  - **파일**: `src/github/github.module.ts`, `src/github/github.service.ts`
  - **의존성**: T-03, T-05 (SummaryResult 인터페이스)
  - **완료 조건**:
    - `@octokit/rest`를 사용한 GitHub API 연동
    - `saveMarkdown(result: SummaryResult, sourceUrl: string): Promise<string>` 메서드 구현
    - 마크다운 파일 생성 (frontmatter: title, date, category, tags, source + 요약 본문)
    - 저장 경로: `90-summaries/YYYY-MM-DD-{slug}.md`
    - 커밋 메시지: `docs: add summary - {한글 제목}`
    - 파일 하단에 `> Auto-generated by Summary Bot on {YYYY-MM-DD}` 포함
    - GitHub API를 통한 파일 생성 (Contents API - PUT)
    - 유닛 테스트: 마크다운 생성, Octokit 호출 검증 (API mock)

---

## Phase 4: Summary 오케스트레이션

> 모든 서비스를 연결하는 핵심 모듈

- [ ] **T-09** Summary 서비스 구현
  - **파일**: `src/summary/summary.module.ts`, `src/summary/summary.service.ts`, `src/summary/dto/summary-result.dto.ts`
  - **의존성**: T-04, T-07, T-08
  - **완료 조건**:
    - `processMessage(text: string): Promise<SummaryResult>` 메서드 구현
    - URL 감지 -> ExtractorService로 본문 추출 -> LlmService로 요약
    - 일반 텍스트 -> 직접 LlmService로 요약
    - 요약 결과를 메모리 캐시에 저장 (TTL 10분)
    - `saveToGithub(cacheKey: string, sourceUrl: string): Promise<string>` 메서드 구현
    - `regenerate(text: string): Promise<SummaryResult>` 메서드 구현
    - 캐시에서 삭제하는 `discard(cacheKey: string): void` 메서드
    - `SummaryModule`에 ExtractorModule, LlmModule, GithubModule import
    - 유닛 테스트: URL 입력 흐름, 텍스트 입력 흐름, 캐시 TTL, 저장/재생성/삭제 동작

---

## Phase 5: Telegram 핸들러 구현

> 사용자 인터페이스 레이어

- [ ] **T-10** Telegram 모듈 및 Webhook 설정
  - **파일**: `src/telegram/telegram.module.ts`, `src/telegram/telegram.service.ts`
  - **의존성**: T-03
  - **완료 조건**:
    - `nestjs-telegraf`를 사용한 모듈 구성
    - `TelegrafModule.forRootAsync()` 설정 (ConfigService에서 token, webhook domain 주입)
    - Webhook 모드 설정 (`launchOptions.webhook`)
    - `main.ts`에서 webhook path 설정
    - Telegram webhook URL: `https://{TELEGRAM_WEBHOOK_DOMAIN}/api/telegram-webhook`

- [ ] **T-11** Telegram 메시지 핸들러 구현
  - **파일**: `src/telegram/telegram.update.ts`
  - **의존성**: T-09, T-10
  - **완료 조건**:
    - `@Update()` 데코레이터를 사용한 핸들러 클래스
    - `@On('text')` 핸들러: 텍스트/URL 수신 -> SummaryService 호출 -> 미리보기 메시지 전송
    - 미리보기 메시지: 요약 제목 + 카테고리 + 태그 + 요약 본문 일부
    - 인라인 키보드 버튼 3개: `저장` / `재생성` / `삭제`
    - `@Action('save')` 핸들러: GitHub에 저장 후 성공 메시지 전송
    - `@Action('regenerate')` 핸들러: 재요약 후 미리보기 갱신
    - `@Action('discard')` 핸들러: 캐시 삭제 + 메시지 삭제
    - 처리 중 상태 표시 (`ctx.reply('요약 중...')` 또는 typing action)
    - 에러 발생 시 사용자에게 에러 메시지 전송
    - 유닛 테스트: 각 핸들러 동작 검증 (ctx mock)

---

## Phase 6: 통합 테스트 및 환경 설정

> 전체 흐름을 검증하고 배포 환경을 준비

- [ ] **T-12** 통합 테스트 작성
  - **파일**: `test/app.e2e-spec.ts`
  - **의존성**: T-11
  - **완료 조건**:
    - E2E 테스트 환경 설정 (테스트용 `.env.test`)
    - URL 입력 -> 요약 -> 미리보기 전체 흐름 테스트 (외부 API mock)
    - 텍스트 입력 -> 요약 -> 미리보기 전체 흐름 테스트
    - 저장 버튼 -> GitHub 저장 흐름 테스트
    - Fallback 시나리오 테스트
    - `pnpm test` 및 `pnpm test:e2e` 모두 통과

- [ ] **T-13** 환경변수 및 .env 템플릿 작성
  - **파일**: `.env.example`, `.gitignore`
  - **의존성**: T-03
  - **완료 조건**:
    - `.env.example`에 모든 필수 환경변수 나열 (값은 placeholder)
    - `.gitignore`에 `.env`, `dist/`, `node_modules/` 포함
    - README에 환경변수 설명 없이 `.env.example` 참조만 명시

---

## Phase 7: Docker 및 Railway 배포

> 프로덕션 배포

- [ ] **T-14** Dockerfile 작성
  - **파일**: `Dockerfile`, `.dockerignore`
  - **의존성**: T-01
  - **완료 조건**:
    - Multi-stage build (builder + runner)
    - Base 이미지: `node:20-alpine`
    - pnpm via corepack enable
    - Builder stage: 의존성 설치 + 빌드 (`pnpm install --frozen-lockfile && pnpm build`)
    - Runner stage: production 의존성만 복사 + `dist/` 복사
    - `EXPOSE 3000`
    - `CMD ["node", "dist/main"]`
    - `.dockerignore`: `node_modules`, `.git`, `.env`, `dist`
    - `docker build` 성공 확인

- [ ] **T-15** Railway 배포 설정
  - **파일**: `railway.toml` (필요 시)
  - **의존성**: T-12, T-14
  - **완료 조건**:
    - Railway 프로젝트 설정 (환경변수 등록)
    - Dockerfile 기반 빌드 확인
    - Webhook URL 설정: `https://{RAILWAY_DOMAIN}/api/telegram-webhook`
    - Health check 엔드포인트 동작 확인
    - Telegram Bot webhook 등록 (`setWebhook`)
    - 실제 Telegram 메시지 전송 -> 요약 -> 저장 E2E 동작 확인

---

## 의존성 그래프

```
T-01 -> T-02 -> T-03 (config)
                T-04 (extractor)     ──┐
                T-05 (claude)        ──┤ 병렬
                T-06 (gemini)        ──┘
                  │
         T-03 + T-05 + T-06 -> T-07 (llm service)
         T-03 + T-05 -> T-08 (github)
                  │
         T-04 + T-07 + T-08 -> T-09 (summary)
         T-03 -> T-10 (telegram module)
                  │
         T-09 + T-10 -> T-11 (telegram handler)
                  │
         T-11 -> T-12 (통합 테스트)
         T-03 -> T-13 (env 템플릿)     ── 병렬
         T-01 -> T-14 (Dockerfile)      ── 병렬
                  │
         T-12 + T-14 -> T-15 (Railway 배포)
```

## 병렬 수행 가능 그룹

| 그룹 | 태스크 | 선행 조건 |
|------|--------|-----------|
| A | T-03, T-04, T-05, T-06 | T-02 완료 |
| B | T-07, T-08 | T-03, T-05, T-06 완료 |
| C | T-09, T-10 | 각 의존성 완료 시 |
| D | T-12, T-13, T-14 | 각 의존성 완료 시 |
